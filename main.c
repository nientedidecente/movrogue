#define STATE_PLAY 0
#define STATE_WIN 1
#define STATE_LOSE 2

#define UP 0
#define RIGHT 1
#define DOWN 2
#define LEFT 3

#define move(direction, x, y) do { \
	if ((direction) == UP) { (y)--; } \
	if ((direction) == RIGHT) { (x)++; } \
	if ((direction) == DOWN) { (y)++; } \
	if ((direction) == LEFT) { (x)--; } \
} while(0)

#define WIDTH 81
#define HEIGHT 24

#define NOT_WALKABLE 0
#define FLOOR 1
#define CORRIDOR 2
#define PLAYER 3
#define AMULET 4

#define map_at(map, x, y) ((map)[(x) + WIDTH * (y)])

char *gen_map(char player_x, char player_y) {
	int i;
	char *map =
		"--------------------------------------------------------------------------------\n"
		"--------------------------------------------------------------------------------\n"
		"--------------------------------------------------------------------------------\n"
		"--------------------------------------------------------------------------------\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................//////////////////////////////////////.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------.................----\n"
		"----.................--------------------------------------..............1..----\n"
		"----.................--------------------------------------.................----\n"
		"--------------------------------------------------------------------------------\n"
		"--------------------------------------------------------------------------------\n"
		"--------------------------------------------------------------------------------\n"
		"--------------------------------------------------------------------------------\n";
	for (i = 0; i < WIDTH * HEIGHT; i++) {
		map[i] -= '-';
	}
	map_at(map, player_x, player_y) = PLAYER;
	return map;
}

/* This does nothing, as expected */
char *gen_map_noop(char *c) {}

typedef struct {
	char direction; 
} Input;

char exec(char player_x, char player_y, char* map, Input in) {
	// Read input
	// Check for winning
	return 0;
}

Input get_input() {
	Input input;
	// Get input
	return input;
}

int main() {
	char state = STATE_PLAY;
	char player_x = 5;
	char player_y = 5;
	char *(*update_map)(char, char) = gen_map;
	char *map = update_map(player_x, player_y);
	update_map = gen_map_noop;
	while (state != (STATE_WIN | STATE_LOSE)) {
		char *map = update_map(player_x, player_y);
		Input in = get_input();
		move(in.direction, player_x, player_y);
		state = exec(player_x, player_y, map, in);
	}
	return 0;
}
